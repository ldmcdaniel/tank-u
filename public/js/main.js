'use strict';

var map, water, sand, grass, trees, bridges, game, marker, layer, cursors, PhaserGame, currentTile;

var game = new Phaser.Game(1024, 768, Phaser.AUTO, 'game');

PhaserGame = function () {};

PhaserGame.prototype = {
  preload: function preload() {
    //This adds the json file from tiles of the map and my images
    this.load.tilemap('map', 'assets/river-defense.json', null, Phaser.Tilemap.TILED_JSON);
    this.load.image('terrain', 'assets/terrain_atlas.png');
    this.load.image('turrets', 'assets/turrets32.png');
    this.load.image('tank', 'assets/enemy10.png');
    this.points = {
      'x': [-16, 100, 200, 300, 400, 500, 600, 700, 740, 675, 600, 500, 400, 300, 205, 180, 190, 290, 390, 490, 590, 690, 790, 850, 860],
      'y': [130, 130, 130, 130, 130, 145, 160, 180, 250, 310, 340, 350, 350, 365, 400, 475, 550, 590, 610, 623, 630, 638, 650, 720, 800]
    };
    this.pi = 0;
  },

  create: function create() {
    this.map = this.add.tilemap('map');

    //The first param is the name of the tileset from tiled; the second is from game.load.image
    this.map.addTilesetImage('terrain_atlas', 'terrain');
    this.map.addTilesetImage('turrets32', 'turrets');

    //Layers from my map
    this.road = this.map.createLayer('Road');
    this.grass = this.map.createLayer('Grass');
    this.trees = this.map.createLayer('Tree bases');
    this.turrets = this.map.createLayer('Turrets');

    //Enemy sprite and travel path information
    this.test = this.add.sprite(-16, 116, 'tank');
    // this.test.scale.setTo(1, 1);
    this.test.anchor.set(0.5);

    this.bmd = this.add.bitmapData(game.width, game.height);
    this.bmd.addToWorld();
    this.plot();

    this.bridges = this.map.createLayer('Tree Tops and Bridges');

    //Mouse marker
    marker = game.add.graphics();
    marker.lineStyle(2, 0, 1);
    marker.drawRect(0, 0, 32, 32);

    currentTile = this.map.getTile(30, 0, 'Turrets');

    this.cursors = game.input.keyboard.createCursorKeys();
  },

  plot: function plot() {

    //Path plot info for the enemy sprites
    this.path = [];
    var ix = 0;
    var x = 1 / game.width;

    for (var i = 0; i <= 1; i += x) {
      var px = this.math.catmullRomInterpolation(this.points.x, i);
      var py = this.math.catmullRomInterpolation(this.points.y, i);

      //This code was before I put the angle rotation of the ships into the code
      // this.path.push( { x: px, y: py });

      //This draws the path onto the screen to edit the path
      // this.bmd.rect(px, py, 1, 1, 'rgba(255, 255, 255, 1)');

      var node = { x: px, y: py, angle: 0 };
      if (ix > 0) {
        node.angle = this.math.angleBetweenPoints(this.path[ix - 1], node);
      }
      this.path.push(node);
      ix++;
    }

    //This code draws rectangles onto the path where the nodes are located
    // for (var p = 0; p < this.points.x.length; p++) {
    //   this.bmd.rect(this.points.x[p]-3, this.points.y[p]-3, 6, 6, 'rgba(255, 0, 0, 1)');
    // }
  },

  update: function update() {

    //Marks the current location of the mouse
    marker.x = this.turrets.getTileX(game.input.activePointer.worldX) * 32;
    marker.y = this.turrets.getTileY(game.input.activePointer.worldY) * 32;

    if (game.input.mousePointer.isDown) {
      if (game.input.keyboard.isDown(Phaser.Keyboard.SHIFT)) {
        currentTile = this.map.getTile(this.turrets.getTileX(marker.x), this.turrets.getTileY(marker.y), 'Turrets');
      } else {
        if (this.map.getTile(this.turrets.getTileX(marker.x), this.turrets.getTileY(marker.y)) !== currentTile) {
          this.map.putTile(currentTile, this.turrets.getTileX(marker.x), this.turrets.getTileY(marker.y), 'Turrets');
        }
      }
    }

    //Information for the path of enemy sprite
    this.test.x = this.path[this.pi].x;
    this.test.y = this.path[this.pi].y;
    this.test.rotation = this.path[this.pi].angle;

    this.pi++;

    if (this.pi >= this.path.length) {
      this.pi = 0;
    }
  }
};

game.state.add('Game', PhaserGame, true);
//# sourceMappingURL=data:application/json;base64,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LEVBQUU7QUFDbEMsVUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsRUFBRTtBQUNyRCxtQkFBVyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsU0FBUyxDQUFDLENBQUM7T0FDN0csTUFBTTtBQUNMLFlBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLFdBQVcsRUFBRTtBQUN0RyxjQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxTQUFTLENBQUMsQ0FBQTtTQUMzRztPQUNGO0tBQ0Y7OztBQUdELFFBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNuQyxRQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDbkMsUUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDOztBQUU5QyxRQUFJLENBQUMsRUFBRSxFQUFFLENBQUM7O0FBRVYsUUFBSSxJQUFJLENBQUMsRUFBRSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFO0FBQy9CLFVBQUksQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0tBQ2I7R0FDRjtDQUNGLENBQUE7O0FBRUQsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLFVBQVUsRUFBRSxJQUFJLENBQUMsQ0FBQyIsImZpbGUiOiJzcmMvanMvbWFpbi5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciBtYXAsIHdhdGVyLCBzYW5kLCBncmFzcywgdHJlZXMsIGJyaWRnZXMsIGdhbWUsIG1hcmtlciwgbGF5ZXIsIGN1cnNvcnMsIFBoYXNlckdhbWUsIGN1cnJlbnRUaWxlO1xuXG52YXIgZ2FtZSA9IG5ldyBQaGFzZXIuR2FtZSgxMDI0LCA3NjgsIFBoYXNlci5BVVRPLCAnZ2FtZScpO1xuXG5QaGFzZXJHYW1lID0gZnVuY3Rpb24gKCkge307XG5cblBoYXNlckdhbWUucHJvdG90eXBlID0ge1xuICBwcmVsb2FkOiBmdW5jdGlvbiAoKSB7XG4gICAgLy9UaGlzIGFkZHMgdGhlIGpzb24gZmlsZSBmcm9tIHRpbGVzIG9mIHRoZSBtYXAgYW5kIG15IGltYWdlc1xuICAgIHRoaXMubG9hZC50aWxlbWFwKCdtYXAnLCAnYXNzZXRzL3JpdmVyLWRlZmVuc2UuanNvbicsIG51bGwsIFBoYXNlci5UaWxlbWFwLlRJTEVEX0pTT04pO1xuICAgIHRoaXMubG9hZC5pbWFnZSgndGVycmFpbicsICdhc3NldHMvdGVycmFpbl9hdGxhcy5wbmcnKTtcbiAgICB0aGlzLmxvYWQuaW1hZ2UoJ3R1cnJldHMnLCAnYXNzZXRzL3R1cnJldHMzMi5wbmcnKTtcbiAgICB0aGlzLmxvYWQuaW1hZ2UoJ3RhbmsnLCAnYXNzZXRzL2VuZW15MTAucG5nJyk7XG4gICAgdGhpcy5wb2ludHM9IHtcbiAgICAgICd4JzogWy0xNiwgMTAwLCAyMDAsIDMwMCwgNDAwLCA1MDAsIDYwMCwgNzAwLCA3NDAsIDY3NSwgNjAwLCA1MDAsIDQwMCwgMzAwLCAyMDUsIDE4MCwgMTkwLCAyOTAsIDM5MCwgNDkwLCA1OTAsIDY5MCwgNzkwLCA4NTAsIDg2MF0sXG4gICAgICAneSc6IFsxMzAsIDEzMCwgMTMwLCAxMzAsIDEzMCwgMTQ1LCAxNjAsIDE4MCwgMjUwLCAzMTAsIDM0MCwgMzUwLCAzNTAsIDM2NSwgNDAwLCA0NzUsIDU1MCwgNTkwLCA2MTAsIDYyMywgNjMwLCA2MzgsIDY1MCwgNzIwLCA4MDBdXG4gICAgfTtcbiAgICB0aGlzLnBpID0gMDtcbiAgfSxcblxuICBjcmVhdGU6IGZ1bmN0aW9uICgpIHtcbiAgICB0aGlzLm1hcCA9IHRoaXMuYWRkLnRpbGVtYXAoJ21hcCcpO1xuXG4gICAgLy9UaGUgZmlyc3QgcGFyYW0gaXMgdGhlIG5hbWUgb2YgdGhlIHRpbGVzZXQgZnJvbSB0aWxlZDsgdGhlIHNlY29uZCBpcyBmcm9tIGdhbWUubG9hZC5pbWFnZVxuICAgIHRoaXMubWFwLmFkZFRpbGVzZXRJbWFnZSgndGVycmFpbl9hdGxhcycsICd0ZXJyYWluJyk7XG4gICAgdGhpcy5tYXAuYWRkVGlsZXNldEltYWdlKCd0dXJyZXRzMzInLCAndHVycmV0cycpXG5cbiAgICAvL0xheWVycyBmcm9tIG15IG1hcFxuICAgIHRoaXMucm9hZCA9IHRoaXMubWFwLmNyZWF0ZUxheWVyKCdSb2FkJyk7XG4gICAgdGhpcy5ncmFzcyA9IHRoaXMubWFwLmNyZWF0ZUxheWVyKCdHcmFzcycpO1xuICAgIHRoaXMudHJlZXMgPSB0aGlzLm1hcC5jcmVhdGVMYXllcignVHJlZSBiYXNlcycpO1xuICAgIHRoaXMudHVycmV0cyA9IHRoaXMubWFwLmNyZWF0ZUxheWVyKCdUdXJyZXRzJyk7XG5cbiAgICAvL0VuZW15IHNwcml0ZSBhbmQgdHJhdmVsIHBhdGggaW5mb3JtYXRpb25cbiAgICB0aGlzLnRlc3QgPSB0aGlzLmFkZC5zcHJpdGUoLTE2LCAxMTYsICd0YW5rJyk7XG4gICAgLy8gdGhpcy50ZXN0LnNjYWxlLnNldFRvKDEsIDEpO1xuICAgIHRoaXMudGVzdC5hbmNob3Iuc2V0KDAuNSk7XG5cbiAgICB0aGlzLmJtZCA9IHRoaXMuYWRkLmJpdG1hcERhdGEoZ2FtZS53aWR0aCwgZ2FtZS5oZWlnaHQpO1xuICAgIHRoaXMuYm1kLmFkZFRvV29ybGQoKTtcbiAgICB0aGlzLnBsb3QoKTtcblxuICAgIHRoaXMuYnJpZGdlcyA9IHRoaXMubWFwLmNyZWF0ZUxheWVyKCdUcmVlIFRvcHMgYW5kIEJyaWRnZXMnKTtcblxuICAgIC8vTW91c2UgbWFya2VyXG4gICAgbWFya2VyID0gZ2FtZS5hZGQuZ3JhcGhpY3MoKTtcbiAgICBtYXJrZXIubGluZVN0eWxlKDIsIDB4MDAwMDAwLCAxKTtcbiAgICBtYXJrZXIuZHJhd1JlY3QoMCwgMCwgMzIsIDMyKTtcblxuICAgIGN1cnJlbnRUaWxlID0gdGhpcy5tYXAuZ2V0VGlsZSgzMCwgMCwgJ1R1cnJldHMnKVxuXG4gICAgdGhpcy5jdXJzb3JzID0gZ2FtZS5pbnB1dC5rZXlib2FyZC5jcmVhdGVDdXJzb3JLZXlzKCk7XG4gIH0sXG5cbiAgcGxvdDogZnVuY3Rpb24gKCkge1xuXG4gICAgLy9QYXRoIHBsb3QgaW5mbyBmb3IgdGhlIGVuZW15IHNwcml0ZXNcbiAgICB0aGlzLnBhdGggPSBbXTtcbiAgICB2YXIgaXggPSAwO1xuICAgIHZhciB4ID0gMSAvIGdhbWUud2lkdGg7XG5cbiAgICBmb3IgKHZhciBpID0gMDsgaSA8PSAxOyBpICs9IHgpIHtcbiAgICAgIHZhciBweCA9IHRoaXMubWF0aC5jYXRtdWxsUm9tSW50ZXJwb2xhdGlvbih0aGlzLnBvaW50cy54LCBpKTtcbiAgICAgIHZhciBweSA9IHRoaXMubWF0aC5jYXRtdWxsUm9tSW50ZXJwb2xhdGlvbih0aGlzLnBvaW50cy55LCBpKTtcblxuICAgICAgLy9UaGlzIGNvZGUgd2FzIGJlZm9yZSBJIHB1dCB0aGUgYW5nbGUgcm90YXRpb24gb2YgdGhlIHNoaXBzIGludG8gdGhlIGNvZGVcbiAgICAgIC8vIHRoaXMucGF0aC5wdXNoKCB7IHg6IHB4LCB5OiBweSB9KTtcblxuICAgICAgLy9UaGlzIGRyYXdzIHRoZSBwYXRoIG9udG8gdGhlIHNjcmVlbiB0byBlZGl0IHRoZSBwYXRoXG4gICAgICAvLyB0aGlzLmJtZC5yZWN0KHB4LCBweSwgMSwgMSwgJ3JnYmEoMjU1LCAyNTUsIDI1NSwgMSknKTtcblxuICAgICAgdmFyIG5vZGUgPSB7eDogcHgsIHk6IHB5LCBhbmdsZTogMH07XG4gICAgICBpZiAoaXggPiAwKSB7XG4gICAgICAgIG5vZGUuYW5nbGUgPSB0aGlzLm1hdGguYW5nbGVCZXR3ZWVuUG9pbnRzKHRoaXMucGF0aFtpeCAtIDFdLCBub2RlKTtcbiAgICAgIH1cbiAgICAgIHRoaXMucGF0aC5wdXNoKG5vZGUpO1xuICAgICAgaXgrKztcbiAgICB9XG5cbiAgICAvL1RoaXMgY29kZSBkcmF3cyByZWN0YW5nbGVzIG9udG8gdGhlIHBhdGggd2hlcmUgdGhlIG5vZGVzIGFyZSBsb2NhdGVkXG4gICAgLy8gZm9yICh2YXIgcCA9IDA7IHAgPCB0aGlzLnBvaW50cy54Lmxlbmd0aDsgcCsrKSB7XG4gICAgLy8gICB0aGlzLmJtZC5yZWN0KHRoaXMucG9pbnRzLnhbcF0tMywgdGhpcy5wb2ludHMueVtwXS0zLCA2LCA2LCAncmdiYSgyNTUsIDAsIDAsIDEpJyk7XG4gICAgLy8gfVxuXG4gIH0sXG5cbiAgdXBkYXRlOiBmdW5jdGlvbiAoKXtcblxuICAgIC8vTWFya3MgdGhlIGN1cnJlbnQgbG9jYXRpb24gb2YgdGhlIG1vdXNlXG4gICAgbWFya2VyLnggPSB0aGlzLnR1cnJldHMuZ2V0VGlsZVgoZ2FtZS5pbnB1dC5hY3RpdmVQb2ludGVyLndvcmxkWCkgKiAzMjtcbiAgICBtYXJrZXIueSA9IHRoaXMudHVycmV0cy5nZXRUaWxlWShnYW1lLmlucHV0LmFjdGl2ZVBvaW50ZXIud29ybGRZKSAqIDMyO1xuXG4gICAgaWYgKGdhbWUuaW5wdXQubW91c2VQb2ludGVyLmlzRG93bikge1xuICAgICAgaWYgKGdhbWUuaW5wdXQua2V5Ym9hcmQuaXNEb3duKFBoYXNlci5LZXlib2FyZC5TSElGVCkpIHtcbiAgICAgICAgY3VycmVudFRpbGUgPSB0aGlzLm1hcC5nZXRUaWxlKHRoaXMudHVycmV0cy5nZXRUaWxlWChtYXJrZXIueCksIHRoaXMudHVycmV0cy5nZXRUaWxlWShtYXJrZXIueSksICdUdXJyZXRzJyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBpZiAodGhpcy5tYXAuZ2V0VGlsZSh0aGlzLnR1cnJldHMuZ2V0VGlsZVgobWFya2VyLngpLCB0aGlzLnR1cnJldHMuZ2V0VGlsZVkobWFya2VyLnkpKSAhPT0gY3VycmVudFRpbGUpIHtcbiAgICAgICAgICB0aGlzLm1hcC5wdXRUaWxlKGN1cnJlbnRUaWxlLCB0aGlzLnR1cnJldHMuZ2V0VGlsZVgobWFya2VyLngpLCB0aGlzLnR1cnJldHMuZ2V0VGlsZVkobWFya2VyLnkpLCAnVHVycmV0cycpXG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvL0luZm9ybWF0aW9uIGZvciB0aGUgcGF0aCBvZiBlbmVteSBzcHJpdGVcbiAgICB0aGlzLnRlc3QueCA9IHRoaXMucGF0aFt0aGlzLnBpXS54O1xuICAgIHRoaXMudGVzdC55ID0gdGhpcy5wYXRoW3RoaXMucGldLnk7XG4gICAgdGhpcy50ZXN0LnJvdGF0aW9uID0gdGhpcy5wYXRoW3RoaXMucGldLmFuZ2xlO1xuXG4gICAgdGhpcy5waSsrO1xuXG4gICAgaWYgKHRoaXMucGkgPj0gdGhpcy5wYXRoLmxlbmd0aCkge1xuICAgICAgdGhpcy5waSA9IDA7XG4gICAgfVxuICB9XG59XG5cbmdhbWUuc3RhdGUuYWRkKCdHYW1lJywgUGhhc2VyR2FtZSwgdHJ1ZSk7XG5cblxuXG5cbiJdfQ==
